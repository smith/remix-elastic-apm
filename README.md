# Remix Elastic APM

_DO NOT USE THIS. THIS PROJECT IS EXPERIMENTAL AND NOT READY FOR PRODUCTION USE_

<p style="text-align: center"><img height=130 src="https://external-content.duckduckgo.com/iu/?u=https%3A%2F%2Fres.cloudinary.com%2Fpracticaldev%2Fimage%2Ffetch%2Fs--MYEAq3yO--%2Fc_limit%252Cf_auto%252Cfl_progressive%252Cq_auto%252Cw_880%2Fhttps%3A%2F%2Fi.imgur.com%2F47Kvvsb.jpg&f=1&nofb=1" /> ðŸ¤œðŸ¤›<svg width="180" height="130" viewBox="0 0 130 130" fill="none" xmlns="http://www.w3.org/2000/svg">
<rect width="130" height="130" fill="none"/>
<path d="M155 66.9575C155.011 63.3043 153.893 59.7368 151.798 56.744C149.703 53.7512 146.734 51.4793 143.298 50.2397C143.61 48.6468 143.766 47.0274 143.766 45.4041C143.763 40.031 142.058 34.7969 138.895 30.4535C135.732 26.11 131.274 22.8809 126.16 21.2297C121.047 19.5786 115.542 19.5905 110.436 21.2636C105.33 22.9368 100.886 26.1851 97.7417 30.5421C95.4229 28.7404 92.5797 27.7439 89.6434 27.7038C86.7071 27.6637 83.8378 28.5821 81.4706 30.3198C79.1034 32.0576 77.3674 34.5198 76.5258 37.3332C75.6842 40.1466 75.7829 43.1576 76.807 45.9099C73.3618 47.1628 70.3832 49.4413 68.2723 52.4385C66.1613 55.4356 65.0193 59.0076 65.0001 62.6736C64.9884 66.3401 66.114 69.92 68.2218 72.9201C70.3297 75.9202 73.316 78.1927 76.7694 79.4247C76.4626 81.0183 76.3073 82.6374 76.3054 84.2603C76.2943 89.6353 77.9924 94.8747 81.1543 99.2213C84.3162 103.568 88.7781 106.797 93.8954 108.441C99.0126 110.086 104.52 110.061 109.622 108.37C114.724 106.679 119.157 103.41 122.279 99.0346C124.591 100.84 127.43 101.842 130.363 101.887C133.297 101.933 136.165 101.02 138.532 99.2867C140.899 97.5536 142.636 95.0953 143.479 92.2852C144.322 89.4751 144.224 86.4667 143.201 83.717C146.644 82.4624 149.62 80.1838 151.729 77.1877C153.838 74.1916 154.98 70.6215 155 66.9575" fill="white"/>
<path d="M100.379 58.6028L120.068 67.576L139.954 50.1729C140.238 48.7346 140.378 47.2715 140.372 45.8054C140.374 41.06 138.857 36.4386 136.041 32.6187C133.226 28.7987 129.261 25.9812 124.727 24.5791C120.194 23.177 115.33 23.264 110.85 24.8276C106.37 26.3911 102.508 29.3488 99.831 33.2671L96.5293 50.4027L100.379 58.6028Z" fill="#FEC514"/>
<path d="M80.0002 79.4542C79.7151 80.9135 79.5751 82.3975 79.5823 83.8844C79.5782 88.6468 81.1019 93.2849 83.9295 97.1171C86.7571 100.949 90.7393 103.773 95.291 105.174C99.8427 106.575 104.724 106.479 109.217 104.9C113.71 103.321 117.578 100.342 120.252 96.4018L123.533 79.3163L119.157 70.9574L99.3719 61.9424L80.0002 79.4542Z" fill="#00BFB3"/>
<path d="M79.8739 45.379L93.3651 48.5637L96.3241 33.221C94.4879 31.8347 92.2526 31.0793 89.9519 31.0675C87.6511 31.0558 85.4082 31.7883 83.5579 33.1558C81.7077 34.5233 80.3492 36.4524 79.6852 38.6553C79.0213 40.8582 79.0874 43.2168 79.8739 45.379" fill="#F04E98"/>
<path d="M78.7042 48.5933C75.7847 49.5543 73.2344 51.3959 71.4039 53.865C69.5734 56.3341 68.5525 59.3095 68.4815 62.3823C68.4105 65.4552 69.2929 68.4745 71.0074 71.0256C72.7219 73.5766 75.1844 75.534 78.0564 76.6289L96.9892 59.5183L93.5119 52.0914L78.7042 48.5933Z" fill="#1BA9F5"/>
<path d="M123.701 96.4016C125.272 97.6099 127.151 98.3535 129.123 98.5478C131.096 98.7422 133.083 98.3796 134.86 97.5013C136.637 96.6229 138.131 95.264 139.175 93.5787C140.218 91.8935 140.768 89.9495 140.762 87.9675C140.767 86.7063 140.549 85.4541 140.118 84.2688L126.635 81.1133L123.701 96.4016Z" fill="#93C90E"/>
<path d="M126.442 77.5775L141.283 81.0506C144.247 80.0524 146.825 78.1538 148.658 75.6198C150.49 73.0858 151.486 70.0429 151.506 66.9158C151.503 63.9025 150.585 60.9613 148.872 58.4823C147.158 56.0034 144.732 54.1039 141.914 53.0359L122.501 70.0462L126.442 77.5775Z" fill="#0077CC"/>
</svg></p>

This package provides helpers for using [Remix](https://remix.run) with
the [Elastic APM Node.js agent](https://www.elastic.co/guide/en/apm/agent/nodejs/master/intro.html)
and the [Elastic APM Real User Monitoring JavaScript agent](https://www.elastic.co/guide/en/apm/agent/rum-js/5.x/intro.html).

While the Elastic APM agents are completely suitable for use with Remix in both
Node.js and browser environments, if you use it with Remix out of the box the
transaction names won't match what you would expect. This package allows you to
patch Remix's server runtime to improve the experience of using Remix with Elastic APM.

This project was the result of some exploratory work on instrumenting Remix, and
hopefully can be used as a starting point for adding official support in the future.

It should work in all Node.js-based environments, but I've only used it with Express.

## Usage

You'll want to have an existing Remix project started with Express Server as the deployment target.

### Elastic cluster configuration

You'll need an Elastic APM server URL and secret token. The easiest way to get this set up is by creating a deployment on [Elastic Cloud](https://www.elastic.co/cloud/).

Once you have a deployment, you can copy the endpoint and secret token from the APM & Fleet page.

You'll want to store these as environment variables. See [the Remix environment variables documentation](https://remix.run/docs/getting-started/v1/guides/envvars) on how to set this up.

You can also use [direnv](https://direnv.net/) locally to manage these variables.

```
ELASTIC_APM_SERVER_URL="https://my-apm-server-url.es.io"
ELASTIC_APM_SECRET_TOKEN=abcdefghijklmnopqr
```

### Install Elastic APM and remix-elastic-apm

`npm install @elastic/apm-rum elastic-apm-node https://github.com/smith/remix-elastic-apm --save`

### Configure the Node.js agent

(We're just following the [Node.js setup instructions](https://www.elastic.co/guide/en/apm/agent/nodejs/master/custom-stack.html) here.)

In your server/index.js add the following to the top of the file:

```js
const apm = require("elastic-apm-node").start({
  serviceName: "my-remix-app-server",
  secretToken: process.env.ELASTIC_APM_SECRET_TOKEN,
  serverUrl: process.env.ELASTIC_APM_SERVER_URL,
  frameworkName: "remix",
});
```

At this point, if you run `npm run dev` to build the Remix bundle, and `npm start` to run Express, then go to http://localhost:3000, transactions will be sent to your Elastic cluster.

If you open Kibana from your deployment and go to Observability > APM, "my-remix-app-server" should show up in the list of services.

You'll see transactions in the service overview, but they all will show up looking like "GET /\*" for the transaction name. That's not very helpful, so let's fix it.

### Patch Remix with Elastic APM instrumentation

The [`addPatch` method](https://www.elastic.co/guide/en/apm/agent/nodejs/master/agent-api.html#apm-add-patch) on the APM agent allows us to wrap loaded modules to change their behavior.

After the `const apm...` code we've added, add:

```js
apm.addPatch(
  "@remix-run/server-runtime",
  require("remix-elastic-apm").patchHandler
);
```

Now in Kibana your transactions will have names like "GET /demos/params/$id", "action /demos/actions", and "loader /index". These should correspond with your routes, actions, and loaders.

### Add client agent configuration to the load context

(it would be nice if this were easier to do, but this gets the job done. I've opened [remix-run/remix#1029](https://github.com/remix-run/remix/issues/1029) requesting a better way to do this.)

In order to do [correlation with the RUM agent](https://www.elastic.co/guide/en/apm/agent/nodejs/master/distributed-tracing.html#tracing-rum-correlation)
we'll need to get some context about the current transaction on the server to send to the client setup.

This will make it so that on page load the agent on the client will be able to correlate its transactions with the server transactions.

Where we currently have `createRequestHandler({ build: require("./build") })`, add:

```js
createRequestHandler({
  getLoadContext: () => {
    return {
      elasticApmRumAgentConfig:
        require("remix-elastic-apm").getElasticApmClientConfig(
          {
            serviceName: "my-remix-app-client",
            serverUrl: process.env.ELASTIC_APM_SERVER_URL,
          },
          apm
        ),
    };
  },
  build: require("./build"),
});
```

(Note that in the default Express setup there are two calls to `createRequestHandler` so you'll need to update both.)

When `getLoadContext` is called it will return something like:

```js
{
  serviceName: 'my-remix-app-client',
  serverUrl: 'https://my-cloud-cluster.es.io',
  pageLoadSpanId: '7f61a915f84d2caa',
  pageLoadTraceId: 'bf51f30595b60e2b5c23f19007ac2c60',
  pageLoadSampled: true
}
```

Return the context from the root loader by adding the following to app/root.tsx:

```js
export const loader: LoaderFunction = async ({ context }) => {
  return { elasticApmRumAgentConfig: context.elasticApmRumAgentConfig };
};
```

### Configure the RUM JS agent

Add this to app/entry.client.tsx before the call to `hydrate`:

```js
import { init as initApm } from "@elastic/apm-rum";
initApm(__remixContext.routeData.root.elasticApmRumAgentConfig);
```

This will initialize the APM agent with the data from the loader context.

Now after loading the app you should see "my-remix-app-client" in your list of services in Kibana.

On the client we record "page-load", "route-change", and "http-request" transactions.

In addition to the transaction data in APM, you can use the [User Experience dashboard](https://www.elastic.co/guide/en/observability/current/user-experience.html) to see and filter useful data about client-side interactions in your Remix app.
